(function(e){function i(t){var n={},r=t.serializeArray();return e.each(r,function(){n[this.name]!==undefined?(n[this.name].push||(n[this.name]=[n[this.name]]),n[this.name].push(this.value||"")):n[this.name]=this.value||""}),/^[0-9]{1,2}\/[0-9]{1,2}\/[0-9]{4}$/.test(n.date_due)&&String(new Date(n.date_due))!=="Invalid Date"?n.date_due=n.date_due.substring(3,5)+"/"+n.date_due.substring(0,2)+"/"+n.date_due.substring(6):n.date_due="",n.user="/rest/v1/user/"+userId+"/",n}function s(){e("#topnav li.hov").removeClass("hov current").find("p").remove();var t,n=Backbone.history.fragment;if(n==""||n=="create/"){n==""?t=e("#topnav li#t_index"):t=e("#topnav li#t_create");if(t.hasClass("hov"))return;t.addClass("hov current").append("<p>"+t.attr("title")+"</p>")}}function o(e){if(e!==""){time=new Date(e);if(time.getDate()<10)var t="0"+time.getDate();else var t=time.getDate();var n=time.getMonth()+1;if(n<10)var n="0"+n;return time=t+"/"+n+"/"+time.getFullYear(),time}}function u(e){var t=new Date,n=new Date(e);if(t.getFullYear()==n.getFullYear()&&t.getMonth()==n.getMonth()&&t.getDate()==n.getDate())return"due";if(t>n)return"inactive";if(t<n)return"active"}var t=function(e){this.bindings=[],Backbone.View.apply(this,[e])};_.extend(t.prototype,Backbone.View.prototype,{bindTo:function(e,t,n){e.bind(t,n,this),this.bindings.push({model:e,ev:t,callback:n})},unbindFromAll:function(){_.each(this.bindings,function(e){e.model.unbind(e.ev,e.callback)}),this.bindings=[]},dispose:function(){this.unbindFromAll(),this.unbind(),this.remove()}}),t.extend=Backbone.View.extend,window.bckb_manager=function(){this.register=function(e){this.currentView&&this.currentView.dispose(),this.currentView=e}};var n=!1,r=e("input[name=csrfmiddlewaretoken]").val();e(document).ajaxSend(function(e,t,n){t.setRequestHeader("X-CSRFToken",r)});var a=Backbone.Model.extend({urlRoot:"/rest/v1/todo/",url:function(){return this.get("resource_uri")||this.urlRoot+(this.id!==undefined?this.id+"/":"")},validate:function(e){var t=["title","text","priority","date_due"],n=_.filter(t,function(t){return e[t]===""}),r=_.filter(t,function(t){return e[t]!==""});if(n.length>0)return[n,r]},initialize:function(){this.bind("error",function(t,n){_.each(n[0],function(t){e("label.l_"+t).css({color:"#c51"})}),_.each(n[1],function(t){e("label.l_"+t).css({color:"#ccc"})}),e("#todo-form .note").css({color:"#c51"})})}}),f=Backbone.Collection.extend({model:a,url:"/rest/v1/todo/?limit=0",parse:function(e){return e.objects}}),l=t.extend({tagName:"tr",className:"todo_row",template:e("#todoTemplate").html(),render:function(){var t=this.model.toJSON();t.status=u(t.date_due),t.date_due=o(t.date_due);var n=_.template(this.template);return t.priority_arr=["low","normal","high"],e(this.el).html(n(t)).attr({"class":t.status}),this},events:{"click .del":"destroyTodo"},destroyTodo:function(e){var t=this;confirm("Are you sure you want to delete this item?")&&this.model.destroy({success:function(e,n){t.dispose(),alert("You have successfully deleted the item!")}})}}),c=t.extend({initialize:function(){_.bindAll(this,"render"),dir_collection=new f,dir_collection.bind("all",this.render),dir_collection.fetch()},render:function(){if(dir_collection.length==0)e("#t_home").hide(),e("#t_add").hide(),app.navigate("create/",{trigger:!0,replace:!0});else{var t=this,n=_.template(e("#indexTemplate").html());e(this.el).html(n()),e("#cont").html(this.el),_.each(dir_collection.models,function(n,r){single_view=t.renderTodo(n),e("#todotable").append(single_view.el)}),e("#logo").html("Todo list")}},renderTodo:function(e,t){var n=new l({model:e,id:"todo_"+e.id});return n.render()}}),h=t.extend({template:e("#detailTemplate").html(),initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.fetch()},render:function(){var t=this.model.attributes;priority_arr=["low","normal","high"];var n=_.template(this.template);t.status=u(t.date_due),t.date_due=o(t.date_due),t.arr=priority_arr,e(this.el).html(n(t)),e("#cont").html(this.el),e("#logo").html("Todo #"+t.id+" details"),e("#item_menu a").hover(function(){e(this).toggleClass("it_hov")})},events:{"click .delete":"destroyTodo"},destroyTodo:function(e){var t=this;confirm("Are you sure you want to delete this item?")&&this.model.destroy({success:function(e,t){app.navigate("",{trigger:!0,replace:!0}),alert("You have successfully deleted the item!")}})}}),p=t.extend({initialize:function(){},render:function(){var t=_.template(e("#createTemplate").html());e(this.el).html(t()),e("#cont").html(this.el),e("#logo").html("Create Todo"),n?e("#Todo_date_due").datepicker({minDate:"0",dateFormat:"dd/mm/yy"}):(e("head").append("<link rel='stylesheet' type='text/css' href='/static/css/jquery-ui-1.9.1.custom.min.css' />"),e.getScript("/static/js/jquery-ui-1.9.1.custom.min.js",function(){e("#Todo_date_due").datepicker({minDate:"0",dateFormat:"dd/mm/yy"})}),n=!0)},events:{"click #btn_create":"create_Todo"},create_Todo:function(t){var n=e("#todo-form"),r=i(n),s=new a,o=s.save(r,{success:function(e,t){var n=o.getResponseHeader("Location"),r=window.corr=n.split("/")[6];app.navigate("view/"+r,{trigger:!0,replace:!0})}})}}),d=t.extend({render:function(){var t=this.model.attributes;t.arr=["low","normal","high"],t.date_due=o(t.date_due);var r=_.template(e("#editTemplate").html());e(this.el).html(r(t)),e("#cont").html(this.el),e("#logo").html("Edit Todo #"+t.id),n?e("#Todo_date_due").datepicker({minDate:"0",dateFormat:"dd/mm/yy"}):(e("head").append("<link rel='stylesheet' type='text/css' href='/static/css/jquery-ui-1.9.1.custom.min.css' />"),e.getScript("/static/js/jquery-ui-1.9.1.custom.min.js",function(){e("#Todo_date_due").datepicker({minDate:"0",dateFormat:"dd/mm/yy"})}),n=!0)},events:{"click #btn_update":"update_Todo","click .delete":"destroyTodo"},update_Todo:function(t){var n=e("#todo-form"),r=i(n);console.log(r.date_due);var s=this.model,o=s.save(r,{success:function(e,t){var n=e.id;app.navigate("view/"+n,{trigger:!0,replace:!0})}})},destroyTodo:function(e){var t=this;confirm("Are you sure you want to delete this item?")&&this.model.destroy({success:function(e,t){app.navigate("",{trigger:!0,replace:!0}),alert("You have successfully deleted the item!")}})}}),v=Backbone.Router.extend({routes:{"":"index","view/:item":"viewTodo","create/":"createTodo","update/:item":"updateTodo"},initialize:function(e){this.manager=window.m=e.manager},index:function(){directory=new c,this.manager.register(directory)},viewTodo:function(e){var t=new h({model:new a({id:Number(e)})});this.manager.register(t)},createTodo:function(){var e=new p({model:new a});e.render(),this.manager.register(e)},updateTodo:function(e){var t=this,n=new a({id:Number(e)});n.fetch({success:function(){var e=new d({model:n});e.render(),t.manager.register(e)}})}});app=new v({manager:new window.bckb_manager}),Backbone.history.start(),Backbone.history.bind("all",function(){s()}),s(),e("#topnav li").on("mouseenter",function(t){e(this).hasClass("hov")||e(this).addClass("hov").append("<p>"+e(this).attr("title")+"</p>")}),e("#topnav li").on("mouseleave",function(t){e(this).hasClass("current")||e(this).removeClass("hov").find("p").remove()})})(jQuery);